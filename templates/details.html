<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic MLS Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: 'Inter', Arial, sans-serif; background: #fff; }
        .container { background: #fff; border: 1.5px solid #333; margin: 32px auto; padding: 24px 18px 18px 18px; max-width: 1400px; box-sizing: border-box; border-radius: 4px; }
        .section-header { background: #1757A6; color: #fff; font-weight: 700; font-size: 1.1rem; padding: 0.25rem 1rem; display: flex; align-items: center; border-radius: 3px 3px 0 0; border: 1.5px solid #1757A6; border-bottom: none; }
        .section-header .icon { font-size: 1.2rem; margin-right: 0.5rem; }
        .edit-btn, .save-btn, .upload-btn, .ekyc-btn, .otp-btn, .add-btn, .cancel-btn { border: 1px solid #1757A6; color: #1757A6; background: #fff; font-size: 0.85rem; border-radius: 3px; padding: 0.1rem 0.7rem; margin-left: 0.5rem; cursor: pointer; font-weight: 500; box-shadow: none; transition: all 0.3s ease; }
        .edit-btn:hover, .save-btn:hover, .upload-btn:hover, .ekyc-btn:hover, .otp-btn:hover, .add-btn:hover, .cancel-btn:hover { background: #1757A6; color: #fff; }
        .save-btn { background: #28a745; border-color: #28a745; color: #fff; }
        .save-btn:hover { background: #218838; }
        .cancel-btn { background: #dc3545; border-color: #dc3545; color: #fff; }
        .cancel-btn:hover { background: #c82333; }
        .edit-btn, .upload-btn, .save-btn, .cancel-btn { float: right; margin-left: 0.5rem; }
        .photo-box { border: 1px solid #1757A6; height: 90%; aspect-ratio: 1/1; min-width: 90px; min-height: 90px; max-width: 140px; max-height: 140px; margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.9rem; color: #1757A6; background: #fff; border-radius: 3px; position: relative; overflow: hidden; }
        .photo-box img { width: 100%; height: 100%; object-fit: cover; }
        .photo-upload { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .img-placeholder { font-size: 1.5rem; color: #bdbdbd; cursor: pointer; transition: all 0.3s ease; }
        .img-placeholder:hover { color: #1757A6; }
        .table th, .table td { border: 1px solid #333; padding: 0.25rem 0.5rem; font-size: 0.97rem; min-height: 28px; height: 28px; background: #fff; }
        .table th { background: #f5f6fa; font-weight: 600; }
        .table { width: 100%; border-collapse: collapse; margin-bottom: 1.1rem; table-layout: fixed; border-radius: 3px; }
        .table th, .table td { word-break: break-word; }
        .table input, .table select, .table textarea { width: 100%; border: none; background: transparent; padding: 0.2rem; font-size: 0.97rem; }
        .table input:focus, .table select:focus, .table textarea:focus { outline: 2px solid #1757A6; border-radius: 2px; }
        .table-col-7 th, .table-col-7 td { width: 14.28%; }
        .table-col-6 th, .table-col-6 td { width: 16.66%; }
        .table-col-4 th, .table-col-4 td { width: 25%; }
        .table-col-2 th, .table-col-2 td { width: 50%; }
        .table-commodities th:nth-child(1), .table-commodities td:nth-child(1) { width: 7%; }
        .table-commodities th:nth-child(2), .table-commodities td:nth-child(2) { width: 23%; }
        .table-commodities th:nth-child(n+3), .table-commodities td:nth-child(n+3) { width: 14%; }
        .table-stock th, .table-stock td { font-size: 0.93rem; padding: 0.15rem 0.3rem; min-height: 24px; height: 24px; }
        .table-stock th { font-size: 1rem; }
        .editable { background: #f8f9fa; }
        .readonly { background: #fff; }
        .success-message, .error-message { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; padding: 0.75rem; border-radius: 0.25rem; margin-bottom: 1rem; display: none; }
        .error-message { background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; }
        .pdf-download-btn { position: fixed; top: 20px; right: 20px; background: #1757A6; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-weight: 600; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .pdf-download-btn:hover { background: #0f4a8c; }
        @media print {
            .edit-btn, .save-btn, .cancel-btn, .upload-btn, .ekyc-btn, .otp-btn, .add-btn, .pdf-download-btn { display: none !important; }
        }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .image-upload-box {
            border: 1px dashed #ccc;
            background-color: #f8f8f8;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            position: relative;
            min-height: 150px;
        }
        .image-upload-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .image-upload-box input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <button class="pdf-download-btn" onclick="window.print()">
        <i class="fas fa-download"></i> Download PDF
    </button>

    <div class="success-message" id="successMessage">Data saved successfully!</div>
    <div class="error-message" id="errorMessage" style="background:#fee2e2; color:#dc2626; border-color:#fecaca;"></div>

    <div class="container" id="details-content">
        <a href="{{ url_for('index') }}" class="edit-btn mb-4 inline-block">Back to Dashboard</a>
        <div class="w-full flex justify-center mb-4">
            <div class="bg-[#1757A6] text-white text-xl font-bold rounded px-10 py-2 mt-2 mb-2" style="border-radius:6px;">MLS AT A GLANCE</div>
        </div>

        <div class="mb-6">
            <div class="section-header">
                <span class="icon">üè¢</span> MLS Point Details
                <button class="edit-btn" onclick="toggleEdit('mls-details')">EDIT</button>
                <button class="save-btn" id="save-mls-details" onclick="saveSection('mls-details')" style="display:none;">SAVE</button>
                <button class="cancel-btn" id="cancel-mls-details" onclick="cancelEdit('mls-details')" style="display:none;">CANCEL</button>
            </div>
            <table class="table table-col-2" id="mls-details">
                <tr><th class="font-bold">MLS Point Code</th><td><span class="readonly" data-field="MLS_Point_Code">{{ info.get('MLS_Point_Code', 'N/A') }}</span></td></tr>
                <tr><th class="font-bold">MLS Point Name</th><td><span class="readonly" data-field="MLS_Point_Name">{{ info.get('MLS_Point_Name', 'N/A') }}</span><input type="text" class="editable" data-field="MLS_Point_Name" value="{{ info.get('MLS_Point_Name', '') }}" style="display:none;"></td></tr>
                <tr><th>District Name</th><td><span class="readonly" data-field="District_Name">{{ info.get('District_Name', 'N/A') }}</span><input type="text" class="editable" data-field="District_Name" value="{{ info.get('District_Name', '') }}" style="display:none;"></td></tr>
                <tr><th>Mandal Name</th><td><span class="readonly" data-field="Mandal_Name">{{ info.get('Mandal_Name', 'N/A') }}</span><input type="text" class="editable" data-field="Mandal_Name" value="{{ info.get('Mandal_Name', '') }}" style="display:none;"></td></tr>
                <tr><th>MLS Point Address</th><td><span class="readonly" data-field="MLS_Point_Address">{{ info.get('MLS_Point_Address', 'N/A') }}</span><textarea class="editable" data-field="MLS_Point_Address" style="display:none; min-height:60px;">{{ info.get('MLS_Point_Address', '') }}</textarea></td></tr>
                <tr><th>Latitude</th><td><span class="readonly" data-field="MLS_Point_Latitude">{{ info.get('MLS_Point_Latitude', 'N/A') }}</span><input type="text" class="editable" data-field="MLS_Point_Latitude" value="{{ info.get('MLS_Point_Latitude', '') }}" style="display:none;"></td></tr>
                <tr><th>Longitude</th><td><span class="readonly" data-field="MLS_Point_Logitude">{{ info.get('MLS_Point_Logitude', 'N/A') }}</span><input type="text" class="editable" data-field="MLS_Point_Logitude" value="{{ info.get('MLS_Point_Logitude', '') }}" style="display:none;"></td></tr>
                <tr><th>Fetch Live Location</th><td><button class="edit-btn" onclick="fetchLocation()"><i class="fas fa-map-marker-alt"></i> Get Directions</button></td></tr>
                <tr><th>Storage Capacity in MTs</th><td><span class="readonly" data-field="Storage_Capacity_in">{{ info.get('Storage_Capacity_in', 'N/A') }}</span><input type="text" class="editable" data-field="Storage_Capacity_in" value="{{ info.get('Storage_Capacity_in', '') }}" style="display:none;"></td></tr>
                <tr><th>Compound Wall Available</th><td><span class="readonly" data-field="Compound_Wall_Available_Yes_No">{{ info.get('Compound_Wall_Available_Yes_No', 'N/A') }}</span><select class="editable" data-field="Compound_Wall_Available_Yes_No" style="display:none;"><option value="Yes" {% if info.get('Compound_Wall_Available_Yes_No') == 'Yes' %}selected{% endif %}>Yes</option><option value="No" {% if info.get('Compound_Wall_Available_Yes_No') == 'No' %}selected{% endif %}>No</option></select></td></tr>
                <tr><th>Distance From Main Road To Reach MLS (in Kms)</th><td><span class="readonly" data-field="Distance_From_Main_Road_To_Reach_MLS_In_Kms">{{ info.get('Distance_From_Main_Road_To_Reach_MLS_In_Kms', 'N/A') }}</span><input type="text" class="editable" data-field="Distance_From_Main_Road_To_Reach_MLS_In_Kms" value="{{ info.get('Distance_From_Main_Road_To_Reach_MLS_In_Kms', '') }}" style="display:none;"></td></tr>
                <tr><th>Internal Roads Available</th><td><span class="readonly" data-field="Internal_Roads_Available_Yes_No">{{ info.get('Internal_Roads_Available_Yes_No', 'N/A') }}</span><select class="editable" data-field="Internal_Roads_Available_Yes_No" style="display:none;"><option value="Yes" {% if info.get('Internal_Roads_Available_Yes_No') == 'Yes' %}selected{% endif %}>Yes</option><option value="No" {% if info.get('Internal_Roads_Available_Yes_No') == 'No' %}selected{% endif %}>No</option></select></td></tr>
            </table>
        </div>

        <div class="flex mb-6">
            <div class="w-3/4">
                <div class="section-header">
                    <span class="icon">üë§</span> Incharge Details
                    <button class="edit-btn" onclick="toggleEdit('incharge-details')">EDIT</button>
                    <button class="save-btn" id="save-incharge-details" onclick="saveSection('incharge-details')" style="display:none;">SAVE</button>
                    <button class="cancel-btn" id="cancel-incharge-details" onclick="cancelEdit('incharge-details')" style="display:none;">CANCEL</button>
                </div>
                <table class="table table-col-2" id="incharge-details">
                    <tr><th>CFMS / Corporation EMP ID</th><td><span class="readonly" data-field="MLS_Point_Incharge_CFMS_Corporation_EMP_ID">{{ info.get('MLS_Point_Incharge_CFMS_Corporation_EMP_ID', 'N/A') }}</span><input type="text" class="editable" data-field="MLS_Point_Incharge_CFMS_Corporation_EMP_ID" value="{{ info.get('MLS_Point_Incharge_CFMS_Corporation_EMP_ID', '') }}" style="display:none;"></td></tr>
                    <tr><th>Name</th><td><span class="readonly" data-field="MLS_Point_Incharge_Name">{{ info.get('MLS_Point_Incharge_Name', 'N/A') }}</span><input type="text" class="editable" data-field="MLS_Point_Incharge_Name" value="{{ info.get('MLS_Point_Incharge_Name', '') }}" style="display:none;"></td></tr>
                    <tr><th>Designation</th><td><span class="readonly" data-field="Designation">{{ info.get('Designation', 'N/A') }}</span><input type="text" class="editable" data-field="Designation" value="{{ info.get('Designation', '') }}" style="display:none;"></td></tr>
                    <tr><th>Aadhaar Number</th><td class="text-right"><span class="readonly" data-field="Aadhaar_Number">{{ info.get('Aadhaar Number', 'N/A') }}</span><input type="text" class="editable" data-field="Aadhaar_Number" value="{{ info.get('Aadhaar_Number', '') }}" style="display:none; width: 70%;"><button class="ekyc-btn">eKYC</button></td></tr>
                    <tr><th>Phone Number</th><td class="text-right"><span class="readonly" data-field="Phone_Number">{{ info.get('Phone Number', 'N/A') }}</span><input type="text" class="editable" data-field="Phone_Number" value="{{ info.get('Phone_Number', '') }}" style="display:none; width: 70%;"><button class="otp-btn">OTP</button></td></tr>
                </table>
            </div>
            <div class="w-1/4 flex flex-col items-center justify-center pl-2">
                <div class="photo-box h-full">
                    <span id="incharge-photo-placeholder">MLS<br>Incharge<br>Photo</span>
                    <img id="incharge-photo-img" src="{{ info.get('MLS_Point_Incharge_Photo', '') }}" style="display:{{ 'block' if info.get('MLS_Point_Incharge_Photo') else 'none' }};">
                    <input type="file" class="photo-upload" accept="image/*" onchange="handlePhotoUpload(this, 'incharge')">
                </div>
            </div>
        </div>

        <div class="flex mb-6">
            <div class="w-3/4">
                <div class="section-header">
                    <span class="icon">üßë‚Äçüíº</span> DEO Details
                    <button class="edit-btn" onclick="toggleEdit('deo-details')">EDIT</button>
                    <button class="save-btn" id="save-deo-details" onclick="saveSection('deo-details')" style="display:none;">SAVE</button>
                    <button class="cancel-btn" id="cancel-deo-details" onclick="cancelEdit('deo-details')" style="display:none;">CANCEL</button>
                </div>
                <table class="table table-col-2" id="deo-details">
                    <tr><th>Corporation Emp ID</th><td><span class="readonly" data-field="DEO_CFMS_ID_Corporation_Emp_ID">{{ info.get('DEO_CFMS_ID_Corporation_Emp_ID', 'N/A') }}</span><input type="text" class="editable" data-field="DEO_CFMS_ID_Corporation_Emp_ID" value="{{ info.get('DEO_CFMS_ID_Corporation_Emp_ID', '') }}" style="display:none;"></td></tr>
                    <tr><th>Name</th><td><span class="readonly" data-field="DEO_Name">{{ info.get('DEO_Name', 'N/A') }}</span><input type="text" class="editable" data-field="DEO_Name" value="{{ info.get('DEO_Name', '') }}" style="display:none;"></td></tr>
                    <tr><th>Aadhaar Number</th><td class="text-right"><span class="readonly" data-field="AadhaarNumber">{{ info.get('Aadhaar  Number', 'N/A') }}</span><input type="text" class="editable" data-field="AadhaarNumber" value="{{ info.get('AadhaarNumber', '') }}" style="display:none; width: 70%;"><button class="ekyc-btn">eKYC</button></td></tr>
                    <tr><th>Phone Number</th><td class="text-right"><span class="readonly" data-field="DEO_Phone_Number">{{ info.get('DEO phone   Number', 'N/A') }}</span><input type="text" class="editable" data-field="DEO_Phone_Number" value="{{ info.get('DEO_Phone_Number', '') }}" style="display:none; width: 70%;"><button class="otp-btn">OTP</button></td></tr>
                </table>
            </div>
            <div class="w-1/4 flex flex-col items-center justify-center pl-2">
                <div class="photo-box h-full">
                    <span id="deo-photo-placeholder">DEO<br>Photo</span>
                    <img id="deo-photo-img" src="{{ info.get('DEO_Photo', '') }}" style="display:{{ 'block' if info.get('DEO_Photo') else 'none' }};">
                    <input type="file" class="photo-upload" accept="image/*" onchange="handlePhotoUpload(this, 'deo')">
                </div>
            </div>
        </div>

        <div class="mb-6">
            <div class="section-header">
                <span class="icon">üè¢</span> MLS Point Physical Details
                <button class="edit-btn" onclick="toggleEdit('physical-details')">EDIT</button>
                <button class="save-btn" id="save-physical-details" onclick="saveSection('physical-details')" style="display:none;">SAVE</button>
                <button class="cancel-btn" id="cancel-physical-details" onclick="cancelEdit('physical-details')" style="display:none;">CANCEL</button>
            </div>
            <table class="table table-col-7" id="physical-details">
                <tr>
                    <th>MLS / Block Name</th>
                    <th>Dimensions</th>
                    <th>Area in Sq. Ft.</th>
                    <th>Storage Capacity in MTs</th>
                    <th>Owned / Hired</th>
                    <th>If rented, Private / AMC / Other</th>
                    <th>Weighbridge Availability</th>
                </tr>
                <tr>
                    <td><span class="readonly" data-field="Block_Name">{{ info.get('Block_Name', 'N/A') }}</span><input type="text" class="editable" data-field="Block_Name" value="{{ info.get('Block_Name', '') }}" style="display:none;"></td>
                    <td><span class="readonly" data-field="Dimensions">{{ info.get('Dimensions', 'N/A') }}</span><input type="text" class="editable" data-field="Dimensions" value="{{ info.get('Dimensions', '') }}" style="display:none;"></td>
                    <td><span class="readonly" data-field="Godown_Area_in_Sq_Ft">{{ info.get('Godown_Area_in_Sq_Ft', 'N/A') }}</span><input type="text" class="editable" data-field="Godown_Area_in_Sq_Ft" value="{{ info.get('Godown_Area_in_Sq_Ft', '') }}" style="display:none;"></td>
                    <td><span class="readonly" data-field="Storage_Capacity_in">{{ info.get('Storage_Capacity_in', 'N/A') }}</span><input type="text" class="editable" data-field="Storage_Capacity_in" value="{{ info.get('Storage_Capacity_in', '') }}" style="display:none;"></td>
                    <td><span class="readonly" data-field="MLS_Point_Owned_or_Hired">{{ info.get('MLS_Point_Owned_or_Hired', 'N/A') }}</span><select class="editable" data-field="MLS_Point_Owned_or_Hired" style="display:none;"><option value="Owned" {% if info.get('MLS_Point_Owned_or_Hired') == 'Owned' %}selected{% endif %}>Owned</option><option value="Hired" {% if info.get('MLS_Point_Owned_or_Hired') == 'Hired' %}selected{% endif %}>Hired</option></select></td>
                    <td><span class="readonly" data-field="If_Rented_Private_Amc_Other">{{ info.get('If_Rented_Private_Amc_Other', 'N/A') }}</span><select class="editable" data-field="If_Rented_Private_Amc_Other" style="display:none;"><option value="N/A" {% if info.get('If_Rented_Private_Amc_Other') == 'N/A' %}selected{% endif %}>N/A</option><option value="Private" {% if info.get('If_Rented_Private_Amc_Other') == 'Private' %}selected{% endif %}>Private</option><option value="AMC" {% if info.get('If_Rented_Private_Amc_Other') == 'AMC' %}selected{% endif %}>AMC</option><option value="Other" {% if info.get('If_Rented_Private_Amc_Other') == 'Other' %}selected{% endif %}>Other</option></select></td>
                    <td><span class="readonly" data-field="Weighbridge_Available_Yes_No">{{ info.get('Weighbridge_Available_Yes_No', 'N/A') }}</span><select class="editable" data-field="Weighbridge_Available_Yes_No" style="display:none;"><option value="Yes" {% if info.get('Weighbridge_Available_Yes_No') == 'Yes' %}selected{% endif %}>Yes</option><option value="No" {% if info.get('Weighbridge_Available_Yes_No') == 'No' %}selected{% endif %}>No</option></select></td>
                </tr>
            </table>
        </div>

        <div class="mb-6">
            <div class="section-header">
                <span class="icon">üè†</span> Hire / Rent Details
                <button class="edit-btn" onclick="toggleEdit('rent-details')">EDIT</button>
                <button class="save-btn" id="save-rent-details" onclick="saveSection('rent-details')" style="display:none;">SAVE</button>
                <button class="cancel-btn" id="cancel-rent-details" onclick="cancelEdit('rent-details')" style="display:none;">CANCEL</button>
            </div>
            <table class="table table-col-4" id="rent-details">
                <tr>
                    <th>Hired / Rented from</th>
                    <th>Rental Period</th>
                    <th>Rental Charges</th>
                    <th>Actions</th>
                </tr>
                <tr>
                    <td><span class="readonly" data-field="Hired_Rented_from">{{ info.get('Hired_Rented_from', 'N/A') }}</span><input type="text" class="editable" data-field="Hired_Rented_from" value="{{ info.get('Hired_Rented_from', '') }}" style="display:none;"></td>
                    <td><span class="readonly" data-field="Rental_Period">{{ info.get('Rental_Period', 'N/A') }}</span><input type="text" class="editable" data-field="Rental_Period" value="{{ info.get('Rental_Period', '') }}" style="display:none;"></td>
                    <td><span class="readonly" data-field="Rental_Charges">{{ info.get('Rental_Charges', 'N/A') }}</span><input type="text" class="editable" data-field="Rental_Charges" value="{{ info.get('Rental_Charges', '') }}" style="display:none;"></td>
                    <td><button class="add-btn" onclick="addRentRow()"><i class="fas fa-plus"></i></button></td>
                </tr>
            </table>
        </div>

        <div class="mb-6">
            <div class="section-header">
                <span class="icon">üñº</span> Location wise Image <span class="text-xs font-normal ml-2">(Upload images)</span>
                <button class="upload-btn" onclick="triggerImageUpload('new-image-upload')">Upload Image</button>
            </div>
            <div class="image-grid" id="location-images-container">
                </div>
        </div>

        <div class="mb-6">
            <div class="section-header">
                <span class="icon">üë∑‚Äç‚ôÇ</span> Hamalies Details
                <button class="edit-btn" onclick="toggleEdit('hamalies-details')">EDIT</button>
                <button class="save-btn" id="save-hamalies-details" onclick="saveSection('hamalies-details')" style="display:none;">SAVE</button>
                <button class="cancel-btn" id="cancel-hamalies-details" onclick="cancelEdit('hamalies-details')" style="display:none;">CANCEL</button>
            </div>
            <table class="table table-col-4 rounded-lg" id="hamalies-details">
                <tr>
                    <th>Hamalies Engaged</th>
                    <th>Rate per Quintal</th>
                    <th>Rate per Carton Box</th>
                    <th>Rate per Bale</th>
                </tr>
                <tr>
                    <td><span class="readonly" data-field="Number_of_Hamalies_Working">{{ info.get('Number_of_Hamalies_Working', 'N/A') }}</span><input type="text" class="editable" data-field="Number_of_Hamalies_Working" value="{{ info.get('Number_of_Hamalies_Working', '') }}" style="display:none;"></td>
                    <td><span class="readonly" data-field="Rate_per_Quintal">{{ info.get('Rate_per_Quintal', 'N/A') }}</span><input type="text" class="editable" data-field="Rate_per_Quintal" value="{{ info.get('Rate_per_Quintal', '') }}" style="display:none;"></td>
                    <td><span class="readonly" data-field="Rate_per_Carton_Box">{{ info.get('Rate_per_Carton_Box', 'N/A') }}</span><input type="text" class="editable" data-field="Rate_per_Carton_Box" value="{{ info.get('Rate_per_Carton_Box', '') }}" style="display:none;"></td>
                    <td><span class="readonly" data-field="Rate_per_Bale">{{ info.get('Rate_per_Bale', 'N/A') }}</span><input type="text" class="editable" data-field="Rate_per_Bale" value="{{ info.get('Rate_per_Bale', '') }}" style="display:none;"></td>
                </tr>
            </table>
        </div>

        <div class="mb-6">
            <div class="section-header">
                <span class="icon">üèó</span> Stage II Contractor Details
                <button class="edit-btn" onclick="toggleEdit('contractor-details')">EDIT</button>
                <button class="save-btn" id="save-contractor-details" onclick="saveSection('contractor-details')" style="display:none;">SAVE</button>
                <button class="cancel-btn" id="cancel-contractor-details" onclick="cancelEdit('contractor-details')" style="display:none;">CANCEL</button>
            </div>
            <div class="flex">
                <div class="w-3/4">
                    <table class="table table-col-2 rounded-lg" id="contractor-details">
                        <tr><th>Engaged Firm Name</th><td><span class="readonly" data-field="Engaged_Firm_Name">{{ info.get('Engaged_Firm_Name', 'N/A') }}</span><input type="text" class="editable" data-field="Engaged_Firm_Name" value="{{ info.get('Engaged_Firm_Name', '') }}" style="display:none;"></td></tr>
                        <tr><th>PAN / GST Details</th><td><span class="readonly" data-field="PAN_GST_Details">{{ info.get('PAN_GST_Details', 'N/A') }}</span><input type="text" class="editable" data-field="PAN_GST_Details" value="{{ info.get('PAN_GST_Details', '') }}" style="display:none;"></td></tr>
                        <tr><th>Owner / Authorised Person Name</th><td><span class="readonly" data-field="Owner_Authorised_Person_Name">{{ info.get('OwnerAuthorised_Person_Name', 'N/A') }}</span><input type="text" class="editable" data-field="Owner_Authorised_Person_Name" value="{{ info.get('Owner_Authorised_Person_Name', '') }}" style="display:none;"></td></tr>
                        <tr><th>Owner / Authorised Aadhaar Number</th><td class="text-right"><span class="readonly" data-field="Owner_Authorised_Aadhaar_Number">{{ info.get('OwnerAuthorised_Aadhaar_Number', 'N/A') }}</span><input type="text" class="editable" data-field="Owner_Authorised_Aadhaar_Number" value="{{ info.get('Owner_Authorised_Aadhaar_Number', '') }}" style="display:none; width: 70%;"><button class="ekyc-btn">eKYC</button></td></tr>
                        <tr><th>Contact Phone Number</th><td class="text-right"><span class="readonly" data-field="Contractor_Phone_Number">{{ info.get('ContractorPhone_Number', 'N/A') }}</span><input type="text" class="editable" data-field="Contractor_Phone_Number" value="{{ info.get('Contractor_Phone_Number', '') }}" style="display:none; width: 70%;"><button class="otp-btn">OTP</button></td></tr>
                        <tr><th>Approved Rate Per Quintal</th><td><span class="readonly" data-field="Approved_Rate_Per_Quintal">{{ info.get('ApprovedRate_Per_Quintal', 'N/A') }}</span><input type="text" class="editable" data-field="Approved_Rate_Per_Quintal" value="{{ info.get('Approved_Rate_Per_Quintal', '') }}" style="display:none;"></td></tr>
                    </table>
                </div>
                <div class="w-1/4 flex flex-col items-center justify-center">
                    <div class="photo-box h-full">
                        <span id="contractor-photo-placeholder">Owner /<br>Authorised<br>Person<br>Photo</span>
                        <img id="contractor-photo-img" src="{{ info.get('Contractor_Photo', '') }}" style="display:{{ 'block' if info.get('Contractor_Photo') else 'none' }};">
                        <input type="file" class="photo-upload" accept="image/*" onchange="handlePhotoUpload(this, 'contractor')">
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-6">
            <div class="section-header">
                <span class="icon">üöö</span> Stage II Vehicle Details
                <button class="edit-btn" onclick="toggleEdit('vehicle-details')">EDIT</button>
                <button class="save-btn" id="save-vehicle-details" onclick="saveSection('vehicle-details')" style="display:none;">SAVE</button>
                <button class="cancel-btn" id="cancel-vehicle-details" onclick="cancelEdit('vehicle-details')" style="display:none;">CANCEL</button>
            </div>
            <table class="table table-col-4 rounded-lg" id="vehicle-details">
                <tr>
                    <th>Vehicles Engaged</th>
                    <th>Own Vehicles Engaged</th>
                    <th>Hired vehicles Engaged</th>
                    <th>GPS Fitted Vehicles</th>
                </tr>
                <tr>
                    <td><span class="readonly" data-field="Number_of_Vehicles_Working">{{ info.get('Number_of_Vehicles_Working', 'N/A') }}</span><input type="text" class="editable" data-field="Number_of_Vehicles_Working" value="{{ info.get('Number_of_Vehicles_Working', '') }}" style="display:none;"></td>
                    <td><span class="readonly" data-field="Number_of_Stage_II_Vehicles_Registered">{{ info.get('Number_of_Stage_II_Vehicles_Registered', 'N/A') }}</span><input type="text" class="editable" data-field="Number_of_Stage_II_Vehicles_Registered" value="{{ info.get('Number_of_Stage_II_Vehicles_Registered', '') }}" style="display:none;"></td>
                    <td><span class="readonly" data-field="Hired_Vehicles_Engaged">{{ info.get('Hired_Vehicles_Engaged', 'N/A') }}</span><input type="text" class="editable" data-field="Hired_Vehicles_Engaged" value="{{ info.get('Hired_Vehicles_Engaged', '') }}" style="display:none;"></td>
                    <td><span class="readonly" data-field="All_Vehicles_Having_GPS_Devices_Yes_No">{{ info.get('All_Vehicles_Having_GPS_Devices_Yes_No', 'N/A') }}</span><input type="text" class="editable" data-field="All_Vehicles_Having_GPS_Devices_Yes_No" value="{{ info.get('All_Vehicles_Having_GPS_Devices_Yes_No', '') }}" style="display:none;"></td>
                </tr>
            </table>
        </div>

        <div class="mb-6">
            <div class="section-header">
                <span class="icon">üì¶</span> Current Month Commodity Details
                <button class="edit-btn" onclick="toggleEdit('commodity-details')">EDIT</button>
                <button class="save-btn" id="save-commodity-details" onclick="saveSection('commodity-details')" style="display:none;">SAVE</button>
                <button class="cancel-btn" id="cancel-commodity-details" onclick="cancelEdit('commodity-details')" style="display:none;">CANCEL</button>
            </div>
            <p class="text-center text-gray-500 py-4">Commodity details will be fetched dynamically from the database.</p>
        </div>

        <div class="mb-6">
            <div class="section-header">
                <span class="icon">üè¨</span> Past Six months Stock Movement Details
                <button class="edit-btn" onclick="toggleEdit('stock-movement')">EDIT</button>
                <button class="save-btn" id="save-stock-movement" onclick="saveSection('stock-movement')" style="display:none;">SAVE</button>
                <button class="cancel-btn" id="cancel-stock-movement" onclick="cancelEdit('stock-movement')" style="display:none;">CANCEL</button>
            </div>
            <p class="text-center text-gray-500 py-4">Stock movement details will be fetched dynamically from the database.</p>
        </div>

        <div class="mb-6">
            <div class="section-header">
                <span class="icon">üì∑</span> CC Cameras Details
                <button class="edit-btn" onclick="toggleEdit('camera-details')">EDIT</button>
                <button class="save-btn" id="save-camera-details" onclick="saveSection('camera-details')" style="display:none;">SAVE</button>
                <button class="cancel-btn" id="cancel-camera-details" onclick="cancelEdit('camera-details')" style="display:none;">CANCEL</button>
            </div>
            <table class="table table-col-4 rounded-lg" id="camera-details">
                <tr>
                    <th>Cameras Maintenance Vendor</th>
                    <th>CC Cameras installed</th>
                    <th>Cameras with Live Feed</th>
                    <th>Actions</th>
                </tr>
                <tr>
                    <td><span class="readonly" data-field="CC_Cameras_are_maintained_by_Vendor">{{ info.get('CC_Cameras_are_maintained_by_Vendor', 'N/A') }}</span><input type="text" class="editable" data-field="CC_Cameras_are_maintained_by_Vendor" value="{{ info.get('CC_Cameras_are_maintained_by_Vendor', '') }}" style="display:none;"></td>
                    <td><span class="readonly" data-field="No_of_CC_Camers_installed">{{ info.get('No_of_CC_Camers_installed', 'N/A') }}</span><input type="text" class="editable" data-field="No_of_CC_Camers_installed" value="{{ info.get('No_of_CC_Camers_installed', '') }}" style="display:none;"></td>
                    <td><span class="readonly" data-field="Whether_all_Cameras_are_in_working_condition_Yes_No">{{ info.get('Whether_all_Cameras_are_in_working_condition_Yes_No', 'N/A') }}</span><input type="text" class="editable" data-field="Whether_all_Cameras_are_in_working_condition_Yes_No" value="{{ info.get('Whether_all_Cameras_are_in_working_condition_Yes_No', '') }}" style="display:none;"></td>
                    <td><button class="add-btn" onclick="addCameraBlock()"><i class="fas fa-plus"></i> Add Block</button></td>
                </tr>
            </table>
        </div>

        <div id="camera-blocks">
            <div class="camera-block mb-4" data-block="1">
                <div class="section-header">
                    <span class="icon">üè¢</span> Block A - Main Storage
                    <button class="edit-btn" onclick="removeCameraBlock(1)" style="background: #dc3545; color: white; border-color: #dc3545;">Remove</button>
                </div>
                <table class="table table-col-2 rounded-lg">
                    <tr><th>Camera 1 Location</th><td><span class="readonly" data-field="Camera_1_Location">{{ info.get('Camera_1_Location', 'N/A') }}</span><input type="text" class="editable" data-field="Camera_1_Location" value="{{ info.get('Camera_1_Location', '') }}" style="display:none;"></td></tr>
                    <tr><th>Camera 1 IP Address</th><td><span class="readonly" data-field="Camera_1_IP_Address">{{ info.get('Camera_1_IP_Address', 'N/A') }}</span><input type="text" class="editable" data-field="Camera_1_IP_Address" value="{{ info.get('Camera_1_IP_Address', '') }}" style="display:none;"></td></tr>
                    <tr><th>Camera 2 Location</th><td><span class="readonly" data-field="Camera_2_Location">{{ info.get('Camera_2_Location', 'N/A') }}</span><input type="text" class="editable" data-field="Camera_2_Location" value="{{ info.get('Camera_2_Location', '') }}" style="display:none;"></td></tr>
                    <tr><th>Camera 2 IP Address</th><td><span class="readonly" data-field="Camera_2_IP_Address">{{ info.get('Camera_2_IP_Address', 'N/A') }}</span><input type="text" class="editable" data-field="Camera_2_IP_Address" value="{{ info.get('Camera_2_IP_Address', '') }}" style="display:none;"></td></tr>
                    <tr><th>Camera 3 Location</th><td><span class="readonly" data-field="Camera_3_Location">{{ info.get('Camera_3_Location', 'N/A') }}</span><input type="text" class="editable" data-field="Camera_3_Location" value="{{ info.get('Camera_3_Location', '') }}" style="display:none;"></td></tr>
                    <tr><th>Camera 3 IP Address</th><td><span class="readonly" data-field="Camera_3_IP_Address">{{ info.get('Camera_3_IP_Address', 'N/A') }}</span><input type="text" class="editable" data-field="Camera_3_IP_Address" value="{{ info.get('Camera_3_IP_Address', '') }}" style="display:none;"></td></tr>
                </table>
            </div>
        </div>

        <div class="mb-6">
            <div class="section-header">
                <span class="icon">üó∫</span> Layout of MLS Point / Block
                <button class="upload-btn" onclick="triggerLayoutUpload()">Upload Layout</button>
            </div>
            <div class="border border-gray-300 h-96 flex items-center justify-center bg-gray-50 rounded">
                <div id="layout-placeholder" class="text-center text-gray-500" style="display:{{ 'none' if info.get('Layout_Image') else 'block' }}">
                    <i class="fas fa-upload text-4xl mb-4"></i>
                    <p>Click "Upload Layout" to add the MLS point layout diagram</p>
                    <p class="text-sm">Supported formats: PNG, JPG, PDF</p>
                </div>
                <img id="layout-image" src="{{ info.get('Layout_Image', '') }}" style="display:{{ 'block' if info.get('Layout_Image') else 'none' }}; max-width:100%; max-height:100%;">
                <input type="file" id="layout-upload" accept="image/*,.pdf" style="display:none;" onchange="handleLayoutUpload(this)">
            </div>
        </div>
    </div>

    <script>
        const mlsPointCode = "{{ info.get('MLS_Point_Code', 'N/A') }}";
        let originalData = {};
        let cameraBlockCounter = 1;

        function showMessage(message, type = 'success') {
            const successMsg = document.getElementById('successMessage');
            const errorMsg = document.getElementById('errorMessage');

            if (type === 'success') {
                successMsg.textContent = message;
                successMsg.style.display = 'block';
                errorMsg.style.display = 'none';
                setTimeout(() => successMsg.style.display = 'none', 3000);
            } else {
                errorMsg.textContent = message;
                errorMsg.style.display = 'block';
                successMsg.style.display = 'none';
                setTimeout(() => errorMsg.style.display = 'none', 5000);
            }
        }

        function toggleEdit(sectionId) {
            const section = document.getElementById(sectionId);
            const editBtn = section.parentElement.querySelector('.edit-btn');
            const saveBtn = section.parentElement.querySelector('.save-btn');
            const cancelBtn = section.parentElement.querySelector('.cancel-btn');
            
            originalData[sectionId] = {};
            section.querySelectorAll('.readonly').forEach(el => {
                const field = el.getAttribute('data-field');
                originalData[sectionId][field] = el.textContent;
                el.style.display = 'none';
            });
            section.querySelectorAll('.editable').forEach(el => {
                el.style.display = 'inline-block';
            });
            
            editBtn.style.display = 'none';
            saveBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'inline-block';
        }

        async function saveSection(sectionId) {
            const section = document.getElementById(sectionId);
            const editBtn = section.parentElement.querySelector('.edit-btn');
            const saveBtn = section.parentElement.querySelector('.save-btn');
            const cancelBtn = section.parentElement.querySelector('.cancel-btn');

            let updates = {};
            section.querySelectorAll('.editable').forEach(el => {
                const field = el.getAttribute('data-field');
                const value = el.value;
                updates[field] = value;
            });

            const updatePromises = Object.entries(updates).map(([column, value]) => {
                return fetch('/update_mls_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ MLS_Point_Code: mlsPointCode, column: column, value: value })
                }).then(response => response.json());
            });

            try {
                const results = await Promise.all(updatePromises);
                const allSuccessful = results.every(result => result.success);

                if (allSuccessful) {
                    showMessage("Data saved successfully!");
                    Object.entries(updates).forEach(([field, value]) => {
                        const readonlyEl = section.querySelector(`.readonly[data-field="${field}"]`);
                        if (readonlyEl) readonlyEl.textContent = value;
                    });
                } else {
                    const firstError = results.find(result => !result.success);
                    showMessage(firstError.message || "An error occurred during save.", 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Network error or server unavailable.', 'error');
            } finally {
                section.querySelectorAll('.readonly').forEach(el => el.style.display = 'inline');
                section.querySelectorAll('.editable').forEach(el => el.style.display = 'none');
                editBtn.style.display = 'inline-block';
                saveBtn.style.display = 'none';
                cancelBtn.style.display = 'none';
            }
        }

        function cancelEdit(sectionId) {
            const section = document.getElementById(sectionId);
            const editBtn = section.parentElement.querySelector('.edit-btn');
            const saveBtn = section.parentElement.querySelector('.save-btn');
            const cancelBtn = section.parentElement.querySelector('.cancel-btn');

            if (originalData[sectionId]) {
                Object.keys(originalData[sectionId]).forEach(field => {
                    const editableEl = section.querySelector(`.editable[data-field="${field}"]`);
                    if (editableEl) {
                        editableEl.value = originalData[sectionId][field];
                    }
                });
            }

            section.querySelectorAll('.readonly').forEach(el => el.style.display = 'inline');
            section.querySelectorAll('.editable').forEach(el => el.style.display = 'none');
            
            editBtn.style.display = 'inline-block';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
        }

        function fetchLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async function(position) {
                    const startLat = position.coords.latitude;
                    const startLng = position.coords.longitude;
                    
                    const endLat = "{{ info.get('MLS_Point_Latitude', '') }}";
                    const endLng = "{{ info.get('MLS_Point_Logitude', '') }}";

                    if (endLat && endLng) {
                        const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${startLat},${startLng}&destination=${endLat},${endLng}`;
                        window.open(mapsUrl, '_blank');
                        showMessage('Opening Google Maps with directions!', 'success');
                    } else {
                        showMessage('MLS Point coordinates are not available in the database.', 'error');
                    }
                }, function(error) {
                    showMessage('Unable to retrieve your current location: ' + error.message, 'error');
                });
            } else {
                showMessage('Geolocation is not supported by this browser.', 'error');
            }
        }
        
        function handlePhotoUpload(input, type) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById(`${type}-photo-img`);
                    const placeholder = document.getElementById(`${type}-photo-placeholder`);
                    
                    img.src = e.target.result;
                    img.style.display = 'block';
                    placeholder.style.display = 'none';
                    showMessage('Photo uploaded. Remember to save the section to make it permanent!', 'success');
                };
                reader.readAsDataURL(file);
            }
        }

        function triggerImageUpload() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.style.display = 'none';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const container = document.getElementById('location-images-container');
                        const imgBox = document.createElement('div');
                        imgBox.className = 'image-upload-box';
                        imgBox.innerHTML = `<img src="${e.target.result}" alt="Location Image"><span class="absolute top-1 right-1 text-red-500 cursor-pointer"><i class="fas fa-times"></i></span>`;
                        imgBox.querySelector('span').addEventListener('click', () => imgBox.remove());
                        container.appendChild(imgBox);
                        showMessage('Image uploaded. Please save the changes to make it permanent!', 'success');
                    };
                    reader.readAsDataURL(file);
                }
            };
            document.body.appendChild(input);
            input.click();
            document.body.removeChild(input);
        }

        document.querySelectorAll('.ekyc-btn').forEach(btn => btn.addEventListener('click', () => alert('eKYC verification initiated.')));
        document.querySelectorAll('.otp-btn').forEach(btn => btn.addEventListener('click', () => alert('OTP sent to phone number.')));

        document.addEventListener('DOMContentLoaded', () => {
            const backButton = document.createElement('a');
            backButton.href = "{{ url_for('index') }}";
            backButton.className = "edit-btn";
            backButton.textContent = "Back to Dashboard";
            document.querySelector('.container').prepend(backButton);
        });
    </script>
</body>
</html>